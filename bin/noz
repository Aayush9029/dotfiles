#!/bin/bash
#***************************************************************************
#*** noz - prevent laptop from sleeping when lid is closed
#***************************************************************************

VERSION="1.0.0"

#***** color scheme *****
GREEN='\033[1;32m'
RED='\033[1;31m'
YELLOW='\033[1;33m'
CYAN='\033[1;36m'
BLUE='\033[1;34m'
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

#***** set defaults *****
DEFAULT_TIMEOUT=45 # in minutes

#***** helper functions *****
print_header() {
    echo -e "${CYAN}${BOLD}⚡ noz${RESET}"
}

print_success() {
    echo -e "${GREEN}✓${RESET} $1"
}

print_error() {
    echo -e "${RED}✗${RESET} $1"
}

print_status() {
    echo -e "  ${GREEN}→${RESET} $1"
}

print_dim() {
    echo -e "  ${DIM}$1${RESET}"
}

#***** show help *****
function show_help() {
    echo
    print_header
    echo -e "  ${DIM}prevent sleep with lid closed${RESET}"
    echo
    echo -e "${BLUE}USAGE${RESET}"
    echo -e "    noz [options]"
    echo
    echo -e "${BLUE}OPTIONS${RESET}"
    echo -e "    -h, --help         Show this help"
    echo -e "    -v, --version      Show version"
    echo -e "    -m, --minutes N    Duration (default: $DEFAULT_TIMEOUT)"
    echo
    echo -e "${BLUE}EXAMPLES${RESET}"
    echo -e "    ${DIM}noz${RESET}               ${DIM}# 45 min (default)${RESET}"
    echo -e "    ${DIM}noz -m 60${RESET}         ${DIM}# 1 hour${RESET}"
    echo -e "    ${DIM}noz -m 5${RESET}          ${DIM}# 5 min${RESET}"
    echo
    echo -e "${DIM}Press Enter to stop early, or wait for timeout.${RESET}"
    echo
    exit 0
}

#***** show version *****
function show_version() {
    echo "noz $VERSION"
    exit 0
}

#***** parse arguments *****
timeout_minutes=$DEFAULT_TIMEOUT

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        -v|--version)
            show_version
            ;;
        -m|--minutes)
            if [[ -z "$2" ]] || ! [[ "$2" =~ ^[0-9]+$ ]]; then
                print_error "--minutes requires a positive integer"
                exit 1
            fi
            timeout_minutes="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            echo -e "${DIM}Use 'noz --help' for usage${RESET}"
            exit 1
            ;;
    esac
done

timeout_seconds=$((timeout_minutes * 60))

#***** print header *****
echo
print_header
echo

#***** ask for sudo upfront *****
sudo -v
if [[ $? -ne 0 ]]; then
    print_error "sudo authentication failed"
    exit 1
fi

#***** get current sleep settings AFTER sudo is authenticated *****

# Get battery sleep setting (more robust parsing)
BATTERY_SLEEP=$(pmset -g custom | awk '/^Battery Power:/,/^AC Power:/ { if ($1 == "sleep") print $2 }')
if [[ -z "$BATTERY_SLEEP" ]] || ! [[ "$BATTERY_SLEEP" =~ ^[0-9]+$ ]]; then
    BATTERY_SLEEP=5  # fallback default
fi

# Get AC sleep setting separately
AC_SLEEP=$(pmset -g custom | awk '/^AC Power:/,0 { if ($1 == "sleep") print $2 }')
if [[ -z "$AC_SLEEP" ]] || ! [[ "$AC_SLEEP" =~ ^[0-9]+$ ]]; then
    AC_SLEEP=10  # fallback default (AC typically has longer sleep)
fi

# Keep sudo alive during script execution
while true; do sudo -n true; sleep 50; kill -0 "$$" || exit; done 2>/dev/null &
SUDO_PID=$!

# Track caffeinate PID
CAFFEINATE_PID=""

function verify_settings() {
    # Verify disablesleep is actually set
    local disabled=$(pmset -g | grep -i "SleepDisabled" | awk '{print $2}')
    if [[ "$disabled" == "1" ]]; then
        return 0
    fi
    return 1
}

function prevent_sleep() {
    print_status "Disabling sleep for ${BOLD}${timeout_minutes} min${RESET}"
    print_dim "Saved: battery=${BATTERY_SLEEP}m, ac=${AC_SLEEP}m"

    # Method 1: Use pmset to disable sleep system-wide (works for lid closed)
    # -a applies to ALL power sources (battery + AC)
    sudo pmset -a sleep 0
    sudo pmset -a disablesleep 1

    # Verify settings took effect
    sleep 0.5
    if ! verify_settings; then
        # Try individual power source settings as fallback
        sudo pmset -b sleep 0 disablesleep 1 2>/dev/null
        sudo pmset -c sleep 0 disablesleep 1 2>/dev/null
    fi

    # Method 2: Also run caffeinate as a belt-and-suspenders approach
    # -d: prevent display sleep, -i: prevent idle sleep, -s: prevent system sleep (AC)
    # -w: wait for process - we use our own PID so it dies when we die
    caffeinate -d -i -s -w $$ &
    CAFFEINATE_PID=$!

    echo
}

function enable_sleep() {
    # $1: exit_reason - "enter" (0), "timeout" (1), "signal" (2)
    local exit_reason="${1:-signal}"

    #----- kill background processes -----
    kill $SUDO_PID 2>/dev/null
    [[ -n "$CAFFEINATE_PID" ]] && kill $CAFFEINATE_PID 2>/dev/null

    # Clear the countdown line
    echo -ne "\r\033[K"

    # Re-enable sleep system-wide first
    sudo pmset -a disablesleep 0

    # Then set individual power source sleep times
    sudo pmset -b sleep $BATTERY_SLEEP
    sudo pmset -c sleep $AC_SLEEP

    # Show appropriate exit message
    if [[ "$exit_reason" == "timeout" ]]; then
        echo -e "${YELLOW}⏱${RESET}  Timeout — sleeping now..."
        sudo pmset sleepnow
    else
        print_success "Sleep restored ${DIM}(battery=${BATTERY_SLEEP}m, ac=${AC_SLEEP}m)${RESET}"
    fi

    echo
    exit 0
}

#***** prevent sleep *****
prevent_sleep

#***** trap signals to ensure we restore settings *****
trap 'enable_sleep signal' INT TERM

#***** countdown loop with live timer *****
remaining=$timeout_seconds

while [[ $remaining -gt 0 ]]; do
    mins=$((remaining / 60))
    secs=$((remaining % 60))

    # Format time as mm:ss
    printf -v time_str "%02d:%02d" $mins $secs

    # Print countdown (overwrite in place)
    echo -ne "\r  ${YELLOW}⏱${RESET}  ${BOLD}${time_str}${RESET} remaining   ${DIM}Press Enter to stop${RESET}  "

    # Non-blocking read with 1 second timeout
    if read -t 1; then
        # Enter was pressed
        enable_sleep enter
    fi

    remaining=$((remaining - 1))
done

#***** timeout reached *****
enable_sleep timeout
