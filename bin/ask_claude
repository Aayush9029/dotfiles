#!/usr/bin/env python3
"""Quick OpenAI prompt - minimal answers with streaming."""

import subprocess
import sys
import os
import json


def ask_openai_stream(prompt: str) -> None:
    """Send prompt to OpenAI Responses API and stream the response using curl."""
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        print("Error: OPENAI_API_KEY not set", file=sys.stderr)
        sys.exit(1)

    payload = json.dumps({
        "model": "gpt-4.1-nano",
        "instructions": "Minimum words. Just the answer. Metric only. No markdown.",
        "input": prompt,
        "stream": True
    })

    cmd = [
        "curl", "-sN",
        "https://api.openai.com/v1/responses",
        "-H", "Content-Type: application/json",
        "-H", f"Authorization: Bearer {api_key}",
        "-d", payload
    ]

    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

    for line in proc.stdout:
        line = line.strip()
        if not line or line.startswith(":"):
            continue
        if line.startswith("data: "):
            data_str = line[6:]
            if data_str == "[DONE]":
                break
            try:
                data = json.loads(data_str)
                event_type = data.get("type", "")
                if event_type == "response.output_text.delta":
                    delta = data.get("delta", "")
                    print(delta, end="", flush=True)
            except json.JSONDecodeError:
                pass

    proc.wait()
    print()  # newline at end


def main():
    if len(sys.argv) > 1:
        prompt = " ".join(sys.argv[1:])
    else:
        try:
            prompt = input("? ")
        except (EOFError, KeyboardInterrupt):
            print()
            sys.exit(0)

    if prompt.strip():
        ask_openai_stream(prompt)


if __name__ == "__main__":
    main()
